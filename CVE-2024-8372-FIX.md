# CVE-2024-8372 Security Fix Documentation

## Vulnerability Summary

**CVE ID:** CVE-2024-8372
**Severity:** Medium (Content Spoofing)
**Affected Components:** `ngSrcset`, `ng-attr-srcset`, `ng-prop-srcset`
**Vulnerability Type:** Improper srcset candidate parsing / Content Spoofing

### Description

CVE-2024-8372 is an improper sanitization vulnerability in AngularJS `srcset` handling that allows bypassing image source restrictions with specially crafted `srcset` strings. The root cause was that the `srcset` candidate splitting logic failed to separate candidates in certain edge cases (e.g., a comma immediately after an invalid descriptor like `xyz` with no whitespace) and did not normalize quotes around individual URL candidates. As a result, some disallowed URLs were not sanitized individually and could appear allowed.

According to [OWASP](https://owasp.org/), Content Spoofing (also referred to as content injection, "arbitrary text injection" or virtual defacement) is an attack targeting a user made possible by an injection vulnerability in a web application. When an application does not properly handle user-supplied data, an attacker can supply content to a web application, typically via a parameter value, that is reflected back to the user. This presents the user with a modified page under the context of the trusted domain.

**Vulnerability Details:**
- Certain `srcset` inputs, such as `https://angularjs.org/favicon.ico xyz,https://evil.example/a.png`, used an invalid descriptor (`xyz`) followed immediately by a comma (no space).
- The candidate-splitting logic did not treat this comma as a separator, so the disallowed second URL was not independently sanitized.
- Quotes around individual URL candidates could also interfere with correct sanitization without prior normalization.
- This allowed a bypass of the `$compileProvider.imgSrcSanitizationTrustedUrlList(...)` domain allowlist and similar restrictions for candidates that were not split/sanitized.

**Affected Versions:** All versions of AngularJS (>=0.0.0)

## Vulnerability Analysis

### Current Implementation (Vulnerable)

The vulnerability did not stem from skipping `$sce.getTrustedMediaUrl()` inside the directives (that was redundant), but from `sanitizeSrcset()` failing to:
1) Treat a comma as a candidate separator when preceded by a non-descriptor token (e.g. `xyz`) with no whitespace; and
2) Normalize wrapping quotes around individual URL candidates before sanitization.

These issues meant a disallowed second candidate could avoid per-candidate sanitization.

### Proper Sanitization

The `sanitizeSrcset()` function in `src/ng/compile.js` correctly:
1. Parses the srcset string to separate multiple URLs
2. Extracts descriptors (e.g., `1x`, `2x`, `128w`)
3. Sanitizes each URL individually using `$sce.getTrustedMediaUrl()`
4. Reconstructs the sanitized srcset string

### Attack Vector (as in the public reproduction)

An attacker could exploit this vulnerability by:

1. **Using `ngSrcset` with an invalid descriptor and no space:**
   ```html
   <img ng-srcset="https://angularjs.org/favicon.ico xyz,https://angular.dev/favicon.ico" />
   ```
   The second URL was not split/sanitized independently and could render.

2. **Bypassing domain restrictions with data: URLs:**
   Even when an application configures `$compileProvider` to only allow images from specific domains:
   ```javascript
   angular.module('app', [])
     .config(['$compileProvider', function($compileProvider) {
       $compileProvider.imgSrcSanitizationTrustedUrlList(
         /^https:\/\/trusted-domain\.com\//
       );
     }]);
   ```
   A `data:image/...` candidate following an invalid descriptor with no space could bypass per-candidate sanitization.

## Fix Implementation

**Commits:** local
**Date:** November 13, 2025
**Author:** Fred Stark

### Changes Made

The fix enhances `sanitizeSrcset()` in `src/ng/compile.js` so that crafted inputs are parsed into distinct candidates and each URL is sanitized individually:
- Strip wrapping single/double quotes from each candidate’s URL before sanitization.
- Improve comma separator detection to treat a comma as a candidate separator when:
  - The token before the comma is not a valid descriptor (`/^\d+(\.\d+)?[xw]$/i`), and
  - The token does not look like part of a URL (to avoid splitting inside URLs such as query strings or `data:`).
- Preserve commas that are part of a URL (e.g., in query strings and data URLs).

Additionally, tests were added to reproduce the public PoC and verify fixes across `ngSrcset`, `ng-attr-srcset`, and `ng-prop-srcset`.

### Why this fixes the CVE
- Craft inputs like `... xyz,https://evil/...` are now split into distinct candidates even without a space after the comma.
- Per-candidate sanitization is applied, so disallowed candidates are prefixed with `unsafe:`.
- Quotes around candidates are removed before sanitization, avoiding mis-parsing/normalization issues.

### Implementation Details

Note: A previous change in `src/ng/directive/attrs.js` avoided redundant `$sce.getTrustedMediaUrl()` for `srcset`, but the actual CVE fix is in `src/ng/compile.js` `sanitizeSrcset()` as described above.

## Files Modified

1. `src/ng/compile.js` - Enhanced `sanitizeSrcset()`:
   - Strip quotes around candidate URLs before sanitization
   - Improve candidate separator detection to handle invalid descriptors with no whitespace
   - Avoid splitting on commas that are part of URLs (query strings, data URLs)
2. `test/ng/directive/ngSrcsetSpec.js` - Added regression tests mirroring the public PoC (invalid descriptor, no whitespace; data URLs; quoted candidates)
3. `test/ng/ngPropSpec.js` - Added corresponding `ng-prop-srcset` tests
4. `test/ng/compileSpec.js` - Kept existing srcset parsing expectations intact and ensured no regressions

## Testing

After implementing the fix, the following should be verified:

1. **Single URL srcset values** work correctly
2. **Multiple URL srcset values** are properly sanitized (each URL individually)
3. **Inputs with invalid descriptors and no whitespace** correctly split and sanitize each candidate
4. **Quoted candidates** are sanitized correctly
5. **data:image/** candidates are sanitized according to the allowlist
6. **Domain restrictions** are properly enforced
7. **Other directives** (`ngSrc`, `ngHref`) continue to work correctly

## References

- **CVE-2024-8372**: Content Spoofing vulnerability in AngularJS ngSrcset sanitization
- **HeroDevs Vulnerability Directory**: https://www.herodevs.com/vulnerability-directory/cve-2024-8372
- **HTML5 srcset specification**: https://html.spec.whatwg.org/multipage/images.html#srcset-attribute
- **OWASP Content Spoofing**: https://owasp.org/www-community/attacks/Content_Spoofing

## Related Vulnerabilities

This vulnerability is related to:
- **CVE-2024-21490**: ReDoS vulnerability in srcset parsing (fixed by replacing regex with linear parser)
- **CVE-2024-8373**: Content Spoofing in `<source>` element srcset sanitization (fixed by extending sanitization to `<source>` elements)

## Status

✅ **FIXED** - The vulnerability has been remediated by hardening `sanitizeSrcset()` in `src/ng/compile.js` to normalize quotes and correctly split candidates (even with invalid descriptors and no whitespace), ensuring per-candidate sanitization and enforcement of the allowlist.

